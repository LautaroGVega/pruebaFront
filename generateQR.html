<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Código QR</title>
    <script>
        let intervalId;
        let countdownIntervalId;
        let countdown = 60;

        // Función para mostrar la información del evento y escultor seleccionados
        function displaySelectedData() {
            const event = document.getElementById('eventSelect').value;
            const sculptor = document.getElementById('sculptorSelect').value;

            document.getElementById('selectedData').innerHTML = `
                <p>Vas a votar en el Evento ${event} para el Escultor ${sculptor}</p>
                <button onclick="generateQRCode()">Generar QR</button>
            `;
        }

        // Función para obtener y mostrar el código QR
        async function generateQRCode() {
            const event = document.getElementById('eventSelect').value;
            const sculptor = document.getElementById('sculptorSelect').value;

            try {
                const response = await fetch(`http://localhost:3000/api/qr/generate?event=${event}&sculptor=${sculptor}`);
                const data = await response.json();

                if (data.qrCode) {
                    document.getElementById('qrCodeContainer').innerHTML = `
                        <img src="${data.qrCode}" alt="QR Code"/>
                        <p>Escanea el código para votar en el evento ${event}, escultor ${sculptor}</p>
                    `;
                } else {
                    console.error('Error: QR code not found in response');
                }

                // Reinicia el contador a 60 segundos cada vez que se genera un nuevo QR
                resetCountdown();
            } catch (error) {
                console.error('Error al generar el QR:', error);
            }
        }

        // Función para iniciar la generación automática de QR y el contador cada 60 segundos
        function startAutoRefresh() {
            generateQRCode(); // Genera el QR inmediatamente
            clearInterval(intervalId); // Limpia cualquier intervalo anterior
            intervalId = setInterval(generateQRCode, 60000); // Actualiza cada 60 segundos
        }

        // Función para reiniciar el contador a 60 segundos
        function resetCountdown() {
            countdown = 60;
            clearInterval(countdownIntervalId); // Limpia el intervalo anterior
            countdownIntervalId = setInterval(() => {
                countdown--;
                document.getElementById('countdown').textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(countdownIntervalId); // Detiene el contador cuando llega a 0
                    countdown = 60; // Reinicia el contador a 60 para la próxima actualización
                }
            }, 1000); // Disminuye el contador cada segundo
        }
    </script>
</head>
<body>
    <h1>Generar Código QR</h1>

    <label for="eventSelect">Selecciona el evento:</label>
    <select id="eventSelect" onchange="displaySelectedData()">
        <option value="1">Evento 1</option>
        <option value="2">Evento 2</option>
        <option value="3">Evento 3</option>
        <!-- Agrega más eventos si es necesario -->
    </select>

    <label for="sculptorSelect">Selecciona el escultor:</label>
    <select id="sculptorSelect" onchange="displaySelectedData()">
        <option value="1">Escultor 1</option>
        <option value="2">Escultor 2</option>
        <option value="3">Escultor 3</option>
        <!-- Agrega más escultores si es necesario -->
    </select>

    <div id="selectedData"></div>

    <div id="qrCodeContainer"></div>
    <p>QR se actualizará en: <span id="countdown">60</span> segundos</p>
</body>
</html>
